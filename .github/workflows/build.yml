name: Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze Code
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
    
    - name: Get dependencies
      working-directory: ./alist_photo
      run: flutter pub get
    
    - name: Analyze project source
      working-directory: ./alist_photo
      run: flutter analyze
    
    - name: Run tests
      working-directory: ./alist_photo
      run: flutter test

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: analyze
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
    
    - name: Get dependencies
      working-directory: ./alist_photo
      run: flutter pub get
    
    - name: Build APK
      working-directory: ./alist_photo
      run: flutter build apk --release
    
    - name: Build AAB
      working-directory: ./alist_photo
      run: flutter build appbundle --release
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: alist_photo/build/app/outputs/flutter-apk/app-release.apk
    
    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-aab
        path: alist_photo/build/app/outputs/bundle/release/app-release.aab

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: analyze
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true
    
    - name: Get dependencies
      working-directory: ./alist_photo
      run: flutter pub get
    
    - name: Pod install
      working-directory: ./alist_photo/ios
      run: pod install
    
    - name: Build iOS (no-codesign)
      working-directory: ./alist_photo
      run: flutter build ios --release --no-codesign
    
    - name: Create IPA
      working-directory: ./alist_photo
      run: flutter build ipa --release --no-codesign
      continue-on-error: true
    
    - name: Upload iOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app
        path: |
          alist_photo/build/ios/iphoneos/Runner.app
          alist_photo/build/ios/ipa/*.ipa
      continue-on-error: true

  create-release:
    name: Create Release
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - uses: actions/checkout@v4
    
    - name: Get version
      id: version
      run: |
        VERSION=$(grep "version:" alist_photo/pubspec.yaml | cut -d " " -f2 | tr -d '\r')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION-$(date +'%Y%m%d')-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
    
    - name: Download Android APK
      uses: actions/download-artifact@v4
      with:
        name: android-apk
        path: ./artifacts/
    
    - name: Download Android AAB
      uses: actions/download-artifact@v4
      with:
        name: android-aab
        path: ./artifacts/
    
    - name: Download iOS App
      uses: actions/download-artifact@v4
      with:
        name: ios-app
        path: ./artifacts/
      continue-on-error: true
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Alist Photo ${{ steps.version.outputs.version }}
        body: |
          # Alist Photo Release ${{ steps.version.outputs.version }}
          
          ## ğŸš€ Features
          - ğŸ“± è·¨å¹³å°æ”¯æŒ Android 13+ å’Œ iOS 16+
          - ğŸ–¼ï¸ æ”¯æŒ Alist æœåŠ¡å™¨å›¾ç‰‡æµè§ˆ
          - ğŸ“ æ–‡ä»¶å¤¹å¯¼èˆªå’Œæµè§ˆ
          - ğŸ” å›¾ç‰‡ç¼©ç•¥å›¾å¹³é“ºæ˜¾ç¤º
          - ğŸ‘ï¸ å…¨å±å›¾ç‰‡æŸ¥çœ‹å™¨ï¼Œæ”¯æŒç¼©æ”¾å’Œæ»‘åŠ¨
          - âš™ï¸ æœåŠ¡å™¨é…ç½®ç®¡ç†
          
          ## ğŸ“± ä¸‹è½½è¯´æ˜
          
          ### Android ç”¨æˆ·
          - **app-release.apk**: æ¨èä¸‹è½½ï¼Œç›´æ¥å®‰è£…ä½¿ç”¨
          - **app-release.aab**: é€‚ç”¨äº Google Play Store å‘å¸ƒ
          
          ### iOS ç”¨æˆ·
          - iOS åº”ç”¨éœ€è¦å¼€å‘è€…è¯ä¹¦ç­¾åï¼Œç›®å‰ä»…æä¾›æœªç­¾åç‰ˆæœ¬
          - å¯ä½¿ç”¨ Xcode æˆ–ç¬¬ä¸‰æ–¹å·¥å…·è¿›è¡Œç­¾ååå®‰è£…
          
          ## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•
          
          1. **å®‰è£…åº”ç”¨**
             - Android: ä¸‹è½½ APK å¹¶å®‰è£…ï¼ˆéœ€è¦å…è®¸æœªçŸ¥æ¥æºï¼‰
             - iOS: éœ€è¦ç­¾ååé€šè¿‡ TestFlight æˆ–å…¶ä»–æ–¹å¼å®‰è£…
          
          2. **é…ç½®æœåŠ¡å™¨**
             - æ‰“å¼€åº”ç”¨åç‚¹å‡»å³ä¸Šè§’è®¾ç½®æŒ‰é’®
             - è¾“å…¥ Alist æœåŠ¡å™¨åœ°å€ (å¦‚: http://192.168.1.100:5244)
             - è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ·åå’Œå¯†ç 
             - ç‚¹å‡»"ä¿å­˜å¹¶æµ‹è¯•è¿æ¥"
          
          3. **å¼€å§‹ä½¿ç”¨**
             - é…ç½®æˆåŠŸåè¿”å›ä¸»ç•Œé¢
             - æµè§ˆæ–‡ä»¶å¤¹å’Œå›¾ç‰‡
             - ç‚¹å‡»å›¾ç‰‡è¿›å…¥å…¨å±æŸ¥çœ‹æ¨¡å¼
          
          ## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - **Android**: Android 13 (API 33) æˆ–æ›´é«˜ç‰ˆæœ¬
          - **iOS**: iOS 16.0 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **ç½‘ç»œ**: éœ€è¦èƒ½å¤Ÿè®¿é—® Alist æœåŠ¡å™¨çš„ç½‘ç»œç¯å¢ƒ
          
          ## ğŸ”§ æŠ€æœ¯ä¿¡æ¯
          - åŸºäº Flutter æ¡†æ¶å¼€å‘
          - æ”¯æŒ HTTP å’Œ HTTPS åè®®
          - ä½¿ç”¨ Alist API v3 è§„èŒƒ
          - æ”¯æŒç¼©ç•¥å›¾å’ŒåŸå›¾åŠ è½½
          
          ---
          
          **æ„å»ºä¿¡æ¯**: ${{ steps.version.outputs.tag }}
          **æ„å»ºæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')
        files: |
          artifacts/app-release.apk
          artifacts/app-release.aab
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}