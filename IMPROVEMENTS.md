# Alist Photo 优化改进文档

## 更新日期: 2025-10-01

## 优化内容

### 1. 上传功能优化

#### 1.1 任务持久化支持
- **功能描述**: 上传任务现在会自动保存到本地存储,即使应用退出或因网络问题中断,重启后也能恢复未完成的任务
- **实现方式**:
  - 使用 SharedPreferences 存储任务队列
  - 任务状态变化时自动保存
  - 应用启动时自动加载并恢复未完成的任务
  - 已完成和已取消的任务不会被持久化
  - 文件不存在的任务会被自动跳过
  
- **优化点**:
  - 网络中断后可恢复上传
  - 应用退出后重启自动继续上传
  - 上传中的任务会重置为待上传状态
  - 支持失败自动重试(最多3次)

#### 1.2 增强的上传队列管理
- **新增功能**:
  - **重试失败项**: 一键重试所有失败的上传任务,重置重试计数和错误信息
  - **清除所有任务**: 取消所有正在上传的任务,清空整个上传队列
  - 更加健壮的并发控制(最多3个并发上传)
  
- **菜单改进**:
  - 清除已完成 - 移除所有已完成和已取消的任务
  - 重试失败项 - 重置并重新上传所有失败的任务
  - 清除所有任务 - 清空所有任务(包括正在上传的)

#### 1.3 上传服务改进
```dart
// 新增方法
- clearAllTasks() - 清除所有上传任务
- retryFailedUploads() - 重试所有失败的上传
- _loadTasks() - 从本地存储加载任务
- _saveTasks() - 保存任务到本地存储
```

### 2. 下载管理功能

#### 2.1 自定义下载路径
- **功能描述**: 用户可以自定义文件下载保存路径
- **默认路径**:
  - Android: `/storage/emulated/0/Download/AlistPhoto`
  - iOS: `应用文档目录/Downloads`
  
- **新增功能**:
  - 查看当前下载路径
  - 修改下载路径(带验证和权限检查)
  - 重置为默认路径
  - 自动创建目录
  - 路径有效性验证

#### 2.2 打开文件管理器
- **功能描述**: 一键打开系统文件管理器查看下载的文件
- **实现方式**:
  - Android: 使用 open_filex 包打开文件管理器
  - iOS: 显示下载路径供用户手动打开
  - 如果无法直接打开,显示路径信息供用户复制

#### 2.3 设置页面新增内容
- **下载管理部分**:
  - 显示当前下载路径
  - 点击路径可修改
  - "打开下载文件夹"按钮
  - 使用说明和提示信息

### 3. FileDownloadService 改进

```dart
// 新增方法
- getDownloadDirectory() - 获取下载目录(支持自定义路径)
- setDownloadDirectory(String path) - 设置自定义下载路径
- resetDownloadDirectory() - 重置为默认路径
- _getDefaultDownloadDirectory() - 获取默认下载目录
```

### 4. 依赖更新

新增依赖包:
```yaml
open_filex: ^4.5.0  # 用于打开文件和文件夹
```

## 使用说明

### 上传功能使用
1. **添加上传任务**: 选择文件后自动添加到队列
2. **自动上传**: 任务添加后会自动开始(如果未达到并发限制)
3. **暂停/继续**: 可以暂停和继续单个任务
4. **重试失败**: 点击菜单中的"重试失败项"重试所有失败任务
5. **清除任务**: 
   - "清除已完成" - 只清除已完成的任务
   - "清除所有任务" - 清空整个队列
6. **自动恢复**: 应用重启后自动恢复未完成的任务

### 下载管理使用
1. **查看路径**: 进入设置页面,在"下载管理"部分查看当前路径
2. **修改路径**: 点击路径栏,输入新路径或点击"重置为默认"
3. **打开文件夹**: 点击"打开下载文件夹"按钮直接查看文件
4. **权限要求**: 确保应用有存储权限

## 技术细节

### 上传任务持久化
- 存储键: `upload_tasks`
- 存储格式: JSON数组
- 序列化: `UploadTask.toJson()`
- 反序列化: `UploadTask.fromJson()`
- 保存时机: 任务状态变化、添加、删除时自动保存

### 下载路径管理
- 存储键: `download_path`
- 验证机制: 目录创建 + 写入测试
- 默认行为: 如果未设置或设置失败,使用默认路径

## 注意事项

1. **权限要求**:
   - Android: 需要存储权限
   - iOS: 应用沙盒内的路径不需要额外权限

2. **上传恢复**:
   - 只恢复未完成的任务(pending, paused, failed)
   - 文件必须仍然存在,否则任务会被跳过
   - 上传中的任务会被重置为待上传状态

3. **路径修改**:
   - 修改路径后新的下载会使用新路径
   - 已下载的文件不会自动移动
   - 确保新路径应用有访问权限

4. **并发限制**:
   - 最多同时上传3个文件
   - 超出的任务会自动排队
   - 一个任务完成后自动启动下一个

## 未来改进建议

1. 批量下载管理
2. 上传/下载速度限制
3. 上传/下载历史记录
4. 文件去重检测
5. 断点续传支持
